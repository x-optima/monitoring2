- name: playbook2
  gather_facts: true
  hosts: zabbixclients
  vars:
    ansible_ssh_user: yc-user
 
  become: yes

  pre_tasks:
    - name: Validating the ssh port is open
      wait_for:
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
        port: 22
        delay: 5
        timeout: 300
        state: started
        search_regex: OpenSSH

  tasks:
    - name: Загрузить переменные из файла
      ansible.builtin.include_vars:
        file: vars.yml

    - name: Полная очистка Docker репозиториев (радикально)
      ansible.builtin.shell: |
        sudo rm -f /etc/apt/sources.list.d/*docker*
        sudo rm -f /etc/apt/sources.list.d/docker*
        sudo rm -f /etc/apt/sources.list.d/download*
        sudo rm -f /etc/apt/keyrings/docker*
        sudo apt update --allow-releaseinfo-change
      become: yes
      ignore_errors: yes

    - name: Очистить APT кэш полностью
      ansible.builtin.command: apt clean
      become: yes

    - name: Установить базовые зависимости
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: no  # ← Без update_cache!
      become: yes

    - name: Создать keyrings директорию
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: Добавить Docker GPG (официальный)
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      become: yes

    - name: Права на GPG ключ
      ansible.builtin.file:
        path: /etc/apt/keyrings/docker.gpg
        mode: '0644'
      become: yes

    - name: Создать ЧИСТЫЙ Docker репозиторий
      ansible.builtin.copy:
        content: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        dest: /etc/apt/sources.list.d/docker.list
      become: yes

    - name: ТЕПЕРЬ обновить APT
      ansible.builtin.apt:
        update_cache: yes
      become: yes


    - name: Установить Docker CE + Compose
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      become: yes

        
    - name: Добавить yc-user в группу docker
      ansible.builtin.user:
        name: yc-user
        groups: docker
        append: yes
      become: yes

    - name: Перезапустить docker после добавления пользователя
      ansible.builtin.systemd:
        name: docker
        state: restarted
      become: yes

    - name: Установить Zabbix Agent Docker
      community.docker.docker_container:
        name: zabbix-agent
        image: zabbix/zabbix-agent2:alpine-7.4-latest
        state: started
        restart_policy: unless-stopped
        network_mode: host
        env:
          ZBX_SERVER_HOST: "{{ groups['zabbixservers'][0] }}"
          ZBX_HOSTNAME: "{{ inventory_hostname }}"
          ZBX_HOSTNAME_ITEM: system.hostname
          ZBX_SERVERACTIVE_HOST: "{{ groups['zabbixservers'][0] }}:10051"
          ZBX_DEBUGLEVEL: "4" 
      become: yes

    - name: Разрешить CPU ключи в Zabbix Agent Docker (БЕЗ ПОИСКА!)
      shell: docker exec zabbix-agent sh -c "echo 'AllowKey=system.cpu.*' >> /etc/zabbix/zabbix_agent2.conf && echo 'AllowKey=system.*' >> /etc/zabbix/zabbix_agent2.conf" || true
      become: yes
      ignore_errors: yes

    - name: Перезапустить Zabbix Agent контейнер
      shell: docker restart zabbix-agent || true
      become: yes
      ignore_errors: yes

  handlers:  # Удалить handlers - они не нужны

