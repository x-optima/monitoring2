# Запускаем командой ansible-playbook -i hosts.ini playbook2.yml --ask-vault-pass

- name: playbook2
  gather_facts: true
  hosts: zabbixclients
  vars:
    ansible_ssh_user: yc-user
    script_dest: /srv/zabbix-agent/my_python_script.py  
    script_owner: root
    script_group: root
    script_mode: '0755' 
  become: yes

  pre_tasks:
    - name: Validating the ssh port is open
      wait_for:
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
        port: 22
        delay: 5
        timeout: 300
        state: started
        search_regex: OpenSSH

  tasks:
    - name: Загрузить переменные из файла
      ansible.builtin.include_vars:
        file: vars.yml

    - name: Полная очистка Docker репозиториев (радикально)
      ansible.builtin.shell: |
        sudo rm -f /etc/apt/sources.list.d/*docker*
        sudo rm -f /etc/apt/sources.list.d/docker*
        sudo rm -f /etc/apt/sources.list.d/download*
        sudo rm -f /etc/apt/keyrings/docker*
        sudo apt update --allow-releaseinfo-change
      become: yes
      ignore_errors: yes

    - name: Очистить APT кэш полностью
      ansible.builtin.command: apt clean
      become: yes

    - name: Установить базовые зависимости
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: no  # ← Без update_cache!
      become: yes

    - name: Создать keyrings директорию
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: Добавить Docker GPG (официальный)
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      become: yes

    - name: Права на GPG ключ
      ansible.builtin.file:
        path: /etc/apt/keyrings/docker.gpg
        mode: '0644'
      become: yes

    - name: Создать ЧИСТЫЙ Docker репозиторий
      ansible.builtin.copy:
        content: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        dest: /etc/apt/sources.list.d/docker.list
      become: yes

    - name: ТЕПЕРЬ обновить APT
      ansible.builtin.apt:
        update_cache: yes
      become: yes


    - name: Установить Docker CE + Compose
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      become: yes
        
    - name: Добавить yc-user в группу docker
      ansible.builtin.user:
        name: yc-user
        groups: docker
        append: yes
      become: yes

    - name: Перезапустить docker после добавления пользователя
      ansible.builtin.systemd:
        name: docker
        state: restarted
      become: yes

    - name: Создать каталог для Zabbix agent файлов
      file:
        path: /srv/zabbix-agent
        state: directory
        mode: "0755"
      become: yes

    - name: Развернуть скрипт fio/date
      copy:
        dest: /srv/zabbix-agent/userparam_fio_date.sh
        mode: "0755"
        content: |
          #!/bin/sh
          case "$1" in
            1) echo "КВН" ;;
            2) date +"%Y-%m-%d %H:%M:%S" ;;
            *) echo "unknown" ;;
          esac
      become: yes

    - name: Копировать Python скрипт В ПРАВИЛЬНОЕ МЕСТО
      copy:
        dest: "{{ script_dest }}"  # /srv/zabbix-agent/my_python_script.py
        content: |
          import sys
          import subprocess
          import re
          from datetime import datetime

          FIO = "KVN"

          if len(sys.argv) < 2:
              print(f"Usage: {sys.argv[0]} <command> [arg]")
              sys.exit(1)

          cmd = sys.argv[1]

          if cmd == '-ping':
              if len(sys.argv) < 3:
                  print("Usage: ./script.py -ping <host>")
                  sys.exit(1)
              try:
                  result = subprocess.check_output(
                      ['ping', '-c', '1', sys.argv[2]], 
                      text=True, 
                      stderr=subprocess.STDOUT,
                      timeout=10
                  )
                  match = re.search(r'time=(.*?) ms', result)
                  if match:
                      print(match.group(1).strip())
                  else:
                      print("Ping failed or no time")
              except subprocess.TimeoutExpired:
                  print("Ping timeout")
              except subprocess.CalledProcessError:
                  print("Ping failed")
              except Exception:
                  print("Ping error")
          elif cmd == '-simple_print':
              if len(sys.argv) < 3:
                  print("Usage: ./script.py -simple_print <text>")
                  sys.exit(1)
              print(sys.argv[2])
          elif cmd == '-1':
              print(FIO)
          elif cmd == '-2':
              print(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
          else:
              print(f"unknown input: {cmd}")
        owner: "{{ script_owner }}"
        group: "{{ script_group }}"
        mode: "{{ script_mode }}"
        backup: yes

    - name: UserParameter конфиг для Docker
      copy:
        dest: /srv/zabbix-agent/zabbix_agent2_userparams.conf
        mode: "0644"
        content: |
          # KVN UserParameters - ПРАВИЛЬНЫЕ пути ВНУТРИ контейнера!
          UserParameter=custom.script.fio,/usr/bin/python3 /usr/local/bin/my_python_script.py -1
          UserParameter=custom.script.date,/usr/bin/python3 /usr/local/bin/my_python_script.py -2
          UserParameter=custom.script.ping[*],/usr/bin/python3 /usr/local/bin/my_python_script.py -ping $1
          UserParameter=custom.script.simple_print[*],/usr/bin/python3 /usr/local/bin/my_python_script.py -simple_print $1
          UserParameter=custom.script.unknown_value[*],/usr/bin/python3 /usr/local/bin/my_python_script.py -unknown $1
          UserParameter=fio.date[*],/etc/zabbix/userparam_fio_date.sh $1
        backup: yes
      become: yes


    - name: Установить Zabbix Agent Docker 
      community.docker.docker_container:
        name: zabbix-agent
        image: zabbix/zabbix-agent2:alpine-7.4-latest
        state: started
        restart_policy: unless-stopped
        network_mode: host
        env:
          ZBX_SERVER_HOST: "{{ groups['zabbixservers'][0] }}"
          ZBX_HOSTNAME: "{{ inventory_hostname }}"
          ZBX_HOSTNAME_ITEM: system.hostname
          ZBX_SERVERACTIVE_HOST: "{{ groups['zabbixservers'][0] }}:10051"
          ZBX_DEBUGLEVEL: "4"
          ZBX_UNSAFEUSERPARAMETERS: "1"
        volumes:
          - /srv/zabbix-agent/my_python_script.py:/usr/local/bin/my_python_script.py:ro  
          - /srv/zabbix-agent/userparam_fio_date.sh:/etc/zabbix/userparam_fio_date.sh:ro
          - /srv/zabbix-agent/zabbix_agent2_userparams.conf:/etc/zabbix/zabbix_agent2.d/userparams.conf:ro
      become: yes

    - name: Установить Python3 в Zabbix Agent Alpine (с root правами)
      shell: |
        docker exec --user root zabbix-agent sh -c "
          apk update && 
          apk add --no-cache python3 py3-pip &&
          ln -sf /usr/bin/python3 /usr/bin/python &&
          echo 'Python3 OK!'
        "
      become: yes

      
    - name: Тест Python скрипта В КОНТЕЙНЕРЕ
      shell: "docker exec zabbix-agent {{ item.command }} || echo 'FAILED'"
      register: tests
      loop:
        - { command: "/usr/bin/python3 /usr/local/bin/my_python_script.py -1", name: "Python FIO" }
        - { command: "/usr/bin/python3 /usr/local/bin/my_python_script.py -2", name: "Python Date" }
        - { command: "/srv/zabbix-agent/userparam_fio_date.sh 1", name: "Bash FIO" }
      changed_when: false
      
    - name: Результаты тестов
      debug:
        msg: "{{ item.item.name }}: {{ item.stdout }}"
      loop: "{{ tests.results }}"
      when: item is succeeded
    - name: Перезапустить Zabbix Agent контейнер
      shell: docker restart zabbix-agent || true
      become: yes
      ignore_errors: yes

 

